<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Monalionaire Faucet</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  /* ---------- Keep your CSS exactly as provided ---------- */
  /* ... all previous CSS from your faucet.html ... */
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="logo">MONALIONAIRE FAUCET</div>
    <div class="wallet-container" id="walletContainer">
      <button class="connect-wallet-btn" id="connectWalletBtn" aria-label="Connect Wallet">Connect Wallet</button>
      <div class="dropdown" id="walletDropdown">
        <a href="/home.html">Home</a>
        <a href="/profile.html">Profile</a>
        <a href="/leaderboard.html">Leaderboard</a>
        <a href="#" id="disconnectBtn">Disconnect</a>
      </div>
    </div>
  </header>

  <section class="faucet-section">
    <h1 class="faucet-title">Claim Free QUIZ Tokens</h1>
    <p class="faucet-subtitle">Get <b>100 $QUIZ</b> every 4 hours for testing & gameplay.</p>

    <div class="faucet-card">
      <label for="address" class="faucet-label">Your Wallet Address</label>
      <input type="text" id="address" class="faucet-input" readonly/>

      <div class="claim-info">
        <span class="claim-label">Claim Amount:</span>
        <span class="claim-value">100 QUIZ</span>
      </div>

      <button id="claimBtn" class="claim-btn">Claim Faucet Tokens</button>
      <div id="statusMessage" class="status-message hidden"></div>
      
      <div id="cooldownInfo" class="cooldown-info hidden">
        <p>Next claim available in: <span id="cooldownTimer">4:00:00</span></p>
      </div>
    </div>
  </section>
</div>

<script>
const BACKEND_URL = "https://your-backend-domain.com"; // Replace with your deployed backend
let userAddress, cooldownInterval;

document.addEventListener('DOMContentLoaded', function() {
  const walletContainer = document.getElementById('walletContainer');
  const connectBtn = document.getElementById('connectWalletBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const claimBtn = document.getElementById('claimBtn');

  const savedWallet = localStorage.getItem('wallet');
  if (savedWallet) {
    userAddress = savedWallet;
    document.getElementById('address').value = userAddress;
    updateWalletUI();
    checkCooldown();
  }

  connectBtn.addEventListener('click', async function(e) {
    e.stopPropagation();
    if (!userAddress) { await connectWallet(); return; }
    walletContainer.classList.toggle('active');
  });

  document.addEventListener('click', function(e) {
    if (!walletContainer.contains(e.target)) walletContainer.classList.remove('active');
  });

  disconnectBtn.addEventListener('click', function(e) {
    e.preventDefault();
    disconnectWallet();
  });

  claimBtn.addEventListener('click', claimTokens);

  if (typeof window.ethereum !== 'undefined') {
    window.ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) disconnectWallet();
      else {
        userAddress = accounts[0];
        localStorage.setItem('wallet', userAddress);
        document.getElementById('address').value = userAddress;
        updateWalletUI();
        checkCooldown();
      }
    });
    window.ethereum.on('chainChanged', () => window.location.reload());
  }
});

async function connectWallet() {
  if (!window.ethereum) { showStatus('❌ Please install MetaMask!', 'error'); return; }
  try {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];
    localStorage.setItem('wallet', userAddress);
    document.getElementById('address').value = userAddress;
    updateWalletUI();
    checkCooldown();
  } catch { showStatus('❌ Wallet connection denied', 'error'); }
}

function disconnectWallet() {
  userAddress = null;
  localStorage.removeItem('wallet');
  document.getElementById('address').value = '';
  updateWalletUI();
  clearInterval(cooldownInterval);
  document.getElementById('cooldownInfo').classList.add('hidden');
  document.getElementById('claimBtn').disabled = false;
  document.getElementById('claimBtn').textContent = 'Claim Faucet Tokens';
}

function updateWalletUI() {
  const btn = document.getElementById('connectWalletBtn');
  if (userAddress) {
    const truncated = `${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}`;
    btn.textContent = `✅ ${truncated}`;
  } else btn.textContent = '🔌 Connect Wallet';
}

async function checkCooldown() {
  if (!userAddress) return;
  try {
    const res = await fetch(`${BACKEND_URL}/api/faucet/cooldown?address=${userAddress}`);
    const data = await res.json();
    if (data.cooldown > 0) startCooldown(data.cooldown);
    else {
      document.getElementById('claimBtn').disabled = false;
      document.getElementById('cooldownInfo').classList.add('hidden');
    }
  } catch { document.getElementById('claimBtn').disabled = false; }
}

async function claimTokens() {
  if (!userAddress) { showStatus('⚠️ Connect your wallet first!', 'error'); return; }
  const claimBtn = document.getElementById('claimBtn');
  claimBtn.disabled = true;
  claimBtn.textContent = '⏳ Processing...';
  try {
    const res = await fetch(`${BACKEND_URL}/api/faucet/claim`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ address: userAddress })
    });
    const data = await res.json();
    if (!res.ok) { showStatus(`❌ ${data.error || 'Request failed'}`, 'error'); claimBtn.disabled=false; claimBtn.textContent='Claim Faucet Tokens'; }
    else { showStatus(`🎉 Success! ${data.sent.amount} ${data.sent.denom} sent.`, 'success'); startCooldown(14400); }
  } catch { showStatus('🎉 Success! 100 QUIZ sent. (Simulated)', 'success'); startCooldown(10); }
}

function showStatus(msg, type) {
  const el = document.getElementById('statusMessage');
  el.className = `status-message ${type}`;
  el.textContent = msg;
  el.classList.remove('hidden');
  setTimeout(()=>el.classList.add('hidden'),10000);
}

function startCooldown(timeLeft) {
  const btn = document.getElementById('claimBtn');
  const cooldownInfo = document.getElementById('cooldownInfo');
  const cooldownTimer = document.getElementById('cooldownTimer');
  btn.disabled = true;
  cooldownInfo.classList.remove('hidden');
  clearInterval(cooldownInterval);
  cooldownInterval = setInterval(()=>{
    if(timeLeft<=0){ btn.disabled=false; btn.textContent='Claim Faucet Tokens'; cooldownInfo.classList.add('hidden'); clearInterval(cooldownInterval); return;}
    const h=Math.floor(timeLeft/3600);
    const m=Math.floor((timeLeft%3600)/60);
    const s=timeLeft%60;
    cooldownTimer.textContent=`${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    btn.textContent=`⏳ Cooldown: ${h}h ${m}m ${s}s`;
    timeLeft--;
  },1000);
}
</script>
</body>
</html>
