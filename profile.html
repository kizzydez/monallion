<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile - Monalionaire</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    /* ====== GENERAL STYLES ====== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background: linear-gradient(135deg,#0E100F 0%,#200052 30%,#0E100F 70%,#200052 100%); min-height:100vh; color:#FBFAF9; position:relative; overflow-x:hidden; }

    /* Background particles */
    .particles { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1; }
    .particle { position:absolute; width:2px; height:2px; background:#836EF9; border-radius:50%; box-shadow:0 0 10px #836EF9,0 0 20px rgba(131,110,249,.7),0 0 30px rgba(131,110,249,.5); animation:float 6s ease-in-out infinite; }
    @keyframes float{0%,100%{transform:translateY(0) rotate(0);opacity:.3;}50%{transform:translateY(-20px) rotate(180deg);opacity:1;}}

    .container{position:relative; z-index:2; max-width:1200px; margin:0 auto; padding:0 20px;}

    /* ====== HEADER ====== */
    .header{display:flex; justify-content:space-between; align-items:center; padding:20px 0; border-bottom:1px solid rgba(131,110,249,.3); background: rgba(14,16,15,.8); backdrop-filter:blur(10px);}
    .logo{font-family:'Orbitron',monospace; font-size:24px; font-weight:700; color:#836EF9; text-shadow:0 0 20px rgba(131,110,249,.8),0 0 40px rgba(131,110,249,.4);}
    .wallet-container{position:relative;}
    .connect-wallet-btn{background:linear-gradient(45deg,#836EF9,#A0055D); color:#FBFAF9; border:2px solid rgba(131,110,249,.5); padding:12px 24px; border-radius:50px; font-weight:600; cursor:pointer; transition:.3s; font-family:'Orbitron',monospace;}
    .connect-wallet-btn:hover{transform:translateY(-2px); box-shadow:0 8px 25px rgba(131,110,249,.6),0 0 30px rgba(131,110,249,.4); border-color:rgba(131,110,249,.8); background:linear-gradient(45deg,#A0055D,#836EF9);}
    .dropdown{display:none; position:absolute; right:0; margin-top:10px; background: rgba(32,0,82,.95); border:1px solid rgba(131,110,249,.4); border-radius:10px; width:180px; backdrop-filter:blur(10px);}
    .wallet-container.active .dropdown{display:block;}
    .dropdown a,.dropdown button{display:block; padding:10px 20px; color:#FBFAF9; text-align:left; text-decoration:none; background:none; border:none; width:100%; cursor:pointer; transition:.2s;}
    .dropdown a:hover,.dropdown button:hover{background:rgba(131,110,249,.2); padding-left:25px;}

    /* ====== PROFILE ====== */
    .profile-container{padding:40px 0; display:grid; grid-template-columns:1fr; gap:30px;}
    .profile-header{background:linear-gradient(135deg,rgba(131,110,249,.1),rgba(32,0,82,.05)); border:2px solid rgba(131,110,249,.4); border-radius:25px; padding:40px; text-align:center; backdrop-filter:blur(5px);}
    .profile-avatar{width:120px;height:120px;border-radius:50%; margin:0 auto 20px; background:radial-gradient(circle,#836EF9,#A0055D,#200052); display:flex; align-items:center; justify-content:center; font-size:3rem; cursor:pointer; position:relative; overflow:hidden; color:#FBFAF9;}
    .profile-avatar img{width:100%; height:100%; object-fit:cover;}
    .profile-avatar:hover::after{content:'‚úé'; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(32,0,82,.7); display:flex; align-items:center; justify-content:center; font-size:2rem; color:#FBFAF9;}
    .profile-name{font-family:'Orbitron',monospace;font-size:2rem;font-weight:900;margin-bottom:10px;cursor:pointer;display:inline-block;padding:5px 10px;border-radius:8px;color:#836EF9;text-shadow:0 0 15px rgba(131,110,249,.5);}
    .profile-name:hover{background:rgba(131,110,249,.1);}
    .wallet-info{color:#d8d8e9;font-size:1rem;margin-bottom:20px; word-break:break-all;}
    .profile-rank{display:inline-block;padding:10px 25px;border-radius:25px;font-weight:700;font-size:1.1rem; background:rgba(131,110,249,.2); border:1px solid rgba(131,110,249,.4); color:#836EF9;}

    .stats-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:20px;}
    .stat-card{background:linear-gradient(135deg,rgba(131,110,249,.1),rgba(32,0,82,.05)); border:2px solid rgba(131,110,249,.3); border-radius:20px; padding:25px; text-align:center; display:flex; flex-direction:column; justify-content:center; backdrop-filter:blur(5px);}
    .stat-card:hover{transform:translateY(-5px); border-color:rgba(131,110,249,.6);}
    .stat-icon{font-size:2.5rem;margin-bottom:15px;color:#836EF9;}
    .stat-value{font-family:'Orbitron',monospace;font-size:2rem;font-weight:900;color:#836EF9;margin-bottom:10px;text-shadow:0 0 15px rgba(131,110,249,.6);}
    .stat-label{color:#836EF9;font-weight:600;font-size:1rem;}

    .tier-progress{margin-top:30px;background:rgba(131,110,249,.1); border-radius:15px; padding:20px; border:1px solid rgba(131,110,249,.3); backdrop-filter:blur(5px);}
    .progress-label{display:flex; justify-content:space-between; margin-bottom:10px; color:#836EF9; font-weight:600;}
    .progress-bar{height:20px;background:rgba(131,110,249,.2); border-radius:10px; overflow:hidden;}
    .progress-fill{height:100%; background:linear-gradient(90deg,#836EF9,#A0055D); border-radius:10px; transition:width 1s ease;}

    .logout-section{text-align:center;margin-top:40px;}
    .logout-btn{background:linear-gradient(45deg,#200052,#0E100F);color:#FBFAF9;border:2px solid rgba(160,5,93,.6); padding:15px 40px;border-radius:25px; font-size:1.1rem; font-weight:600; cursor:pointer;}
    .logout-btn:hover{background:linear-gradient(45deg,#A0055D,#836EF9);transform:translateY(-2px);}

    /* MODALS */
    .modal{display:none;position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(14,16,15,.9); z-index:100; align-items:center; justify-content:center;}
    .modal-content{background:linear-gradient(135deg,#200052,#0E100F); border:2px solid #836EF9; border-radius:20px; padding:30px; width:90%; max-width:500px;}
    .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;}
    .modal-title{font-family:'Orbitron',monospace; color:#836EF9; font-size:1.5rem;}
    .close-modal{background:none;border:none;color:#FBFAF9;font-size:1.5rem; cursor:pointer;}
    .form-group{margin-bottom:20px;}
    .form-group label{display:block;margin-bottom:8px;color:#836EF9;font-weight:600;}
    .form-group input{width:100%; padding:12px 15px; border-radius:10px; border:1px solid #836EF9; background:rgba(131,110,249,.1); color:#FBFAF9;}
    .file-input{display:none;}
    .file-label{display:block; padding:12px 15px; border-radius:10px; border:1px dashed #836EF9; background:rgba(131,110,249,.1); color:#836EF9; text-align:center; cursor:pointer;}
    .modal-actions{display:flex; justify-content:flex-end; gap:15px;}
    .modal-btn{padding:10px 20px;border-radius:50px;border:none;font-weight:600;cursor:pointer;}
    .modal-btn.cancel{background:rgba(160,5,93,.2); color:#A0055D;border:1px solid #A0055D;}
    .modal-btn.save{background:linear-gradient(45deg,#836EF9,#A0055D); color:#FBFAF9;}
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>

  <div class="container">
    <header class="header">
      <div class="logo">MONALIONAIRE</div>
      <div class="wallet-container" id="walletContainer">
        <button class="connect-wallet-btn" id="connectWalletBtn">Connect Wallet</button>
        <div class="dropdown" id="walletDropdown">
          <a href="/home.html">Home</a>
          <a href="/paystart.html">Pay Start</a>
          <a href="/gamepage.html">Game Page</a>
          <a href="#" id="disconnectBtn">Disconnect</a>
        </div>
      </div>
    </header>

    <div class="profile-container">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar"><span id="avatarEmoji">üë§</span></div>
        <h1 class="profile-name" id="profileName">Player</h1>
        <div class="wallet-info" id="walletInfo">Wallet: Not connected</div>
        <div class="profile-rank" id="profileRank">üèÜ Bronze Player</div>
        <div class="tier-progress">
          <div class="progress-label"><span>Progress to next tier</span><span id="progressPercentage">0%</span></div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><span class="stat-icon">üéÆ</span><div class="stat-value" id="gamesPlayed">0</div><div class="stat-label">Games Played</div></div>
        <div class="stat-card"><span class="stat-icon">üí∞</span><div class="stat-value" id="totalWinnings">0</div><div class="stat-label">Total Winnings</div></div>
        <div class="stat-card"><span class="stat-icon">üî•</span><div class="stat-value" id="millionStreaks">0</div><div class="stat-label">Million Streaks</div></div>
        <div class="stat-card"><span class="stat-icon">‚ö°</span><div class="stat-value" id="successRate">0%</div><div class="stat-label">Success Rate</div></div>
      </div>

      <div class="logout-section"><button class="logout-btn" id="logoutBtn">Log Out</button></div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="nameModal">
    <div class="modal-content">
      <div class="modal-header"><h2 class="modal-title">Edit Display Name</h2><button class="close-modal">&times;</button></div>
      <div class="form-group"><label for="displayName">Display Name</label><input type="text" id="displayName" maxlength="20"></div>
      <div class="modal-actions"><button class="modal-btn cancel">Cancel</button><button class="modal-btn save" id="saveNameBtn">Save Changes</button></div>
    </div>
  </div>

  <div class="modal" id="avatarModal">
    <div class="modal-content">
      <div class="modal-header"><h2 class="modal-title">Change Avatar</h2><button class="close-modal">&times;</button></div>
      <div class="form-group">
        <label for="avatarUpload">Upload Image</label>
        <input type="file" id="avatarUpload" class="file-input" accept="image/*">
        <label for="avatarUpload" class="file-label">Choose image (max 100KB)</label>
      </div>
    </div>
  </div>

  <script>
  const BACKEND_URL = window.location.origin;
  let userAddress = localStorage.getItem('wallet') || null;

  document.addEventListener('DOMContentLoaded', async () => {
    const walletContainer = document.getElementById('walletContainer');
    const connectBtn = document.getElementById('connectWalletBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');

    if(userAddress) { updateWalletUI(); await loadProfileData(); }

    connectBtn.addEventListener('click', async e=>{
      e.stopPropagation();
      if(!userAddress){ await connectWallet(); return; }
      walletContainer.classList.toggle('active');
    });

    document.addEventListener('click', e=>{
      if(!walletContainer.contains(e.target)) walletContainer.classList.remove('active');
    });

    disconnectBtn.addEventListener('click', e=>{ e.preventDefault(); disconnectWallet(); });

    if(typeof window.ethereum !== 'undefined'){
      window.ethereum.on('accountsChanged', async accounts=>{
        if(accounts.length===0) disconnectWallet();
        else{ userAddress=accounts[0]; localStorage.setItem('wallet', userAddress); updateWalletUI(); await loadProfileData(); }
      });
      window.ethereum.on('chainChanged', ()=>window.location.reload());
    }

    // Profile edit modals
    const profileAvatar = document.getElementById('profileAvatar');
    const profileName = document.getElementById('profileName');
    const nameModal = document.getElementById('nameModal');
    const avatarModal = document.getElementById('avatarModal');

    profileAvatar.addEventListener('click', ()=>{ avatarModal.style.display='flex'; });
    profileName.addEventListener('click', ()=>{ nameModal.style.display='flex'; });

    document.querySelectorAll('.close-modal,.cancel').forEach(btn=>{
      btn.addEventListener('click', ()=>{ nameModal.style.display='none'; avatarModal.style.display='none'; });
    });

    document.getElementById('saveNameBtn').addEventListener('click', async ()=>{
      const newName=document.getElementById('displayName').value.trim();
      if(!newName) return alert('Enter a valid name');
      await fetch(`${BACKEND_URL}/api/profile/update`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({wallet:userAddress, name:newName})
      });
      profileName.textContent=newName; nameModal.style.display='none';
    });

    document.getElementById('avatarUpload').addEventListener('change', async e=>{
      const file=e.target.files[0]; if(!file) return;
      if(file.size>100*1024) return alert('File too large');
      const reader=new FileReader();
      reader.onload=async function(){ 
        await fetch(`${BACKEND_URL}/api/profile/update`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({wallet:userAddress, avatar:reader.result}) });
        profileAvatar.innerHTML=`<img src="${reader.result}" />`;
        avatarModal.style.display='none';
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=>{ disconnectWallet(); });
  });

  async function connectWallet(){
    if(typeof window.ethereum==='undefined') return alert('MetaMask not detected');
    const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
    if(accounts.length>0){ userAddress=accounts[0]; localStorage.setItem('wallet', userAddress); updateWalletUI(); await loadProfileData(); }
  }

  function disconnectWallet(){
    localStorage.removeItem('wallet'); userAddress=null;
    document.getElementById('walletInfo').textContent='Wallet: Not connected';
    document.getElementById('connectWalletBtn').textContent='Connect Wallet';
  }

  function updateWalletUI(){
    document.getElementById('walletInfo').textContent='Wallet: '+userAddress;
    document.getElementById('connectWalletBtn').textContent=userAddress.slice(0,6)+'...'+userAddress.slice(-4);
  }

  async function loadProfileData(){
    try{
      const res=await fetch(`${BACKEND_URL}/api/profile/${userAddress}`);
      const data=await res.json();
      if(data.name) document.getElementById('profileName').textContent=data.name;
      if(data.avatar) document.getElementById('profileAvatar').innerHTML=`<img src="${data.avatar}" />`;
      document.getElementById('gamesPlayed').textContent=data.gamesPlayed||0;
      document.getElementById('totalWinnings').textContent=data.totalWinnings||0;
      document.getElementById('millionStreaks').textContent=data.millionStreaks||0;
      document.getElementById('successRate').textContent=(data.successRate||0)+'%';
      document.getElementById('progressFill').style.width=(data.progress||0)+'%';
      document.getElementById('progressPercentage').textContent=(data.progress||0)+'%';
      document.getElementById('profileRank').textContent=data.rank||'üèÜ Bronze Player';
    }catch(err){ console.error(err); }
  }
  </script>
</body>
</html>
